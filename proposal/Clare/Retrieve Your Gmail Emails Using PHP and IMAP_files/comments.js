define(["events","js!lib/mootools-more/Fx.Scroll.js"],function(e){function c(e){return e}var t,n,r="comment",i=r+"s",s=r+"_parent",o="#"+i+" > li",u="removeMe",a="data-"+r,f="working",l="disabled";return{aceSession:null,setAvatars:function(e){var t="data-avatar";$$(e||"#"+i+" li["+t+"]").each(function(e){(new Element("img",{src:e.get(t),"class":"avatar"})).inject(e),e.erase(t)})},setTextareas:function(){$$(o).each(this.addTextareaToSingleLiBlock)},addTextareaToSingleLiBlock:function(e){function s(e){var n=$("cForm").getFirst(e);n&&n.clone().inject(t)}var t,n,r,i=e.getNext();return i=i&&i.get("tag")=="ul"?i:(new Element("ul")).inject(e,"after"),t=(new Element("li",{"class":"commentTextarea"})).inject(i),n=(new Element("textarea",{placeHolder:"Respond...",name:"comment","data-comment":e.get(a)})).inject(t),r=(new Element("input",{name:"comment_parent",type:"hidden",value:e.get(a)})).inject(t),s("input[name=comment_post_ID]"),s("#_wp_unfiltered_html_comment"),n},onTextareaFocus:function(e){var n,r,i,s,o=e.getParent("li");if(o.hasClass("focused"))return;o.addClass("focused"),n=e.get(a),i=this,s=(new Element("button",{html:"Submit",href:"javascript:;","class":"sexyButton",events:{click:function(){var u=e.get("value").trim();if(u==""){e.focus();return}s.addClass(l);var a=z.d.body;a.addClass(f),e.set("value",c(e.get("value"))),t=(new Request({url:$("cForm").action,method:"post",evalScripts:!0,onRequest:function(){z.d.body.addClass(f)},onSuccess:function(t){var u=i.addComment(t,n,o);i.setAvatars(u),o.removeClass("focused"),s.destroy(),e.set("value","").setStyle("height",0),r&&r.set("html",""),i.scrollTo(u)},onComplete:function(){a.removeClass(f)}})).send(o.toQueryString())}}})).inject(o);if(!e.get("plugged")){r=(new Element("div",{"class":"measureDiv"})).inject(e,"before");function u(){return e}function h(){return r}["keyup","keydown","mouseup"].each(function(e){u().addEvent(e,function(){value=u().get("value"),value.charAt(value.length-1)=="\n"&&(value+="&nbsp;"),value=value.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />"),h().set("html",value).setStyle("width",parseInt(u().getStyle("width"),10)),u().setStyle("height",h().getScrollHeight()+20)})}),e.set("plugged",1)}},submitForm:function(n){var i,o,u,a,f,h;t&&t.cancel(),i=this,o=$(z.d.body),u=u,a=$(r),f=c(a.get("value")),$(a).set("value",f),h=a.getNext("input[type='submit']"),h.addClass(l),t=(new Request({url:n.action,method:"post",onSuccess:function(t){var n=$(s).value,r=i.addComment(t.trim(),n),o=$$("#cForm input[name=author]");n&&!o.length?i.addTextareaToSingleLiBlock(r):n||i.setReplyLinks(r),i.setAvatars(r),i.reset(),i.scrollTo(r),e.publish("/comments/added")},onComplete:function(){o.removeClass(u),h.removeClass(l)}})).send(n.toQueryString()),o.addClass(u)},setReplyLinks:function(e){$$(e||o).each(function(e){var t=(new Element("a",{"class":"reply",text:"Reply",href:"javascript:;",title:"Reply",events:{click:function(){var e=this.getParent("li"),t="commentForm",n,r=e;$(s).set("value",e.get(a)),n=e.getNext(),n&&n.get("tag")=="ul"&&(r=(new Element("li",{"class":u})).inject(n)),$(t).inject(r),$$("#"+t+" input[name=author], #comment")[0].focus()}}})).inject(e)})},addComment:function(t,n,s){var u,f,l,c=new Element("div",{html:t}),h=c.getFirst("li").addClass("new"),p=n?h:h.getElements(".detailContent").addClass("new");return n?(u=$$(o+"["+a+"="+n+"]")[0],f=u.getNext(),l=f&&f.get("tag")=="ul"?f:(new Element("ul",{"class":"children"})).inject(u,"after"),s?h.inject(s,"before"):h.inject(l)):h.inject($(i)),c.destroy(),e.publish(r+"s/added",{li:h,isMain:!n}),setTimeout(function(){p&&p.removeClass("new")},1e3),h},reset:function(){$("commentForm").inject($("commentFormHolder")),$(s).value="",$(r).set("value",""),$$("#"+i+" ."+u).destroy(),this.aceSession&&this.aceSession.setValue("")},scrollTo:function(e){n||(n=new Fx.Scroll(z.w)),n.toElement(e)},createEditor:function(e,t){var n="lib/ace/";curl(["js!"+n+"ace.js!order","js!"+n+"theme-dreamweaver.js!order","js!"+n+"mode-javascript.js!order"],function(){var n,r,i=e,s="acebox",o=(new Element("div",{id:s+"Holder"})).inject(i,"after");(new Element("div",{id:s})).inject(o),(new Element("div",{id:s+"Message",html:"Please still wrap your code in &lt;pre&gt; tags<br /><br />Ex: &lt;pre class='js'&gt;/* code */&lt;/code&gt;"})).inject(o,"after"),i.setStyle("display","none"),t&&t.setStyle("display","none"),n=ace.edit(s),n.setTheme("ace/theme/dreamweaver"),r=this.aceSession=n.getSession(),r.setMode((new require("ace/mode/javascript")).Mode()),r.setValue(i.get("value")),r.on("change",function(){i.set("value",n.getSession().getValue())}),setTimeout(function(){n.focus()},1e3),aceLoaded=1})}}});